# æœåŠ¡å‘ç°

### ä¸‰ç§æ¨¡å¼

1. **æœåŠ¡æä¾›è€…ï¼ˆRPC Serverï¼‰**ï¼šåœ¨å¯åŠ¨æ—¶ï¼Œå‘ Registry æ³¨å†Œè‡ªèº«æœåŠ¡ï¼Œå¹¶å‘ Registry å®šæœŸå‘é€å¿ƒè·³æ±‡æŠ¥å­˜æ´»çŠ¶æ€ã€‚
2. **æœåŠ¡æ¶ˆè´¹è€…ï¼ˆRPC Clientï¼‰**ï¼šåœ¨å¯åŠ¨æ—¶ï¼Œå‘ Registry è®¢é˜…æœåŠ¡ï¼ŒæŠŠ Registry è¿”å›çš„æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ç¼“å­˜åœ¨æœ¬åœ°å†…å­˜ä¸­ï¼Œå¹¶ä¸ RPC Sever å»ºç«‹è¿æ¥ã€‚
3. **æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆRegistryï¼‰**ï¼šç”¨äºä¿å­˜ RPC Server çš„æ³¨å†Œä¿¡æ¯ï¼Œå½“ RPC Server èŠ‚ç‚¹å‘ç”Ÿå˜æ›´æ—¶ï¼ŒRegistry ä¼šåŒæ­¥å˜æ›´ï¼ŒRPC Client æ„ŸçŸ¥åä¼šåˆ·æ–°æœ¬åœ° å†…å­˜ä¸­ç¼“å­˜çš„æœåŠ¡èŠ‚ç‚¹åˆ—è¡¨ã€‚

### CAPç†è®º

- ä¸€è‡´æ€§(Consistency)ï¼šæ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´å…·æœ‰ç›¸åŒçš„æ•°æ®ï¼›
- å¯ç”¨æ€§(Availability) ï¼šä¿è¯æ¯ä¸ªè¯·æ±‚ä¸ç®¡æˆåŠŸæˆ–è€…å¤±è´¥éƒ½æœ‰å“åº”ï¼›
- åˆ†éš”å®¹å¿(Partition tolerance) ï¼šç³»ç»Ÿä¸­ä»»æ„ä¿¡æ¯çš„ä¸¢å¤±æˆ–å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿçš„ç»§ç»­è¿ä½œã€‚

### åˆ†å¸ƒå¼åè®®

1. Paxosã€Raftã€[ZAB](https://zhida.zhihu.com/search?content_id=192937056&content_type=Article&match_order=1&q=ZAB&zd_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJ6aGlkYV9zZXJ2ZXIiLCJleHAiOjE3NjU0MzcyODksInEiOiJaQUIiLCJ6aGlkYV9zb3VyY2UiOiJlbnRpdHkiLCJjb250ZW50X2lkIjoxOTI5MzcwNTYsImNvbnRlbnRfdHlwZSI6IkFydGljbGUiLCJtYXRjaF9vcmRlciI6MSwiemRfdG9rZW4iOm51bGx9.UgmfTvimEgB3EvSgw4GdJmgfmtsiIqyl4SjbCcIrrzo&zhida_source=entity)ã€‚ raftç®€æ˜“ç‰ˆ ETCDéƒ½æ˜¯ä½¿ç”¨ä»–

### ä¸¤ç§æ¨¡å¼

1. å®¢æˆ·ç«¯å‘ç°
    1. å®¢æˆ·ç«¯æœåŠ¡å‘ç°æ¨¡å¼å…¼å…·å¤šç§ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚è¿™ç§æ¨¡å¼ç›¸å¯¹ç®€å•ç›´æ¥ï¼Œé™¤äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒä¹‹å¤–ï¼Œæ²¡æœ‰å…¶ä»–å¤æ‚çš„ç»„ä»¶ã€‚æ­¤å¤–ï¼Œç”±äºå®¢æˆ·ç«¯äº†è§£å¯ç”¨çš„æœåŠ¡å®ä¾‹ï¼Œå› æ­¤å¯ä»¥åšå‡ºæ™ºèƒ½çš„ã€ç‰¹å®šäºåº”ç”¨ç¨‹åºçš„è´Ÿè½½å‡è¡¡å†³ç­–ï¼Œä¾‹å¦‚å§‹ç»ˆä½¿ç”¨å“ˆå¸Œç®—æ³•ã€‚è¿™ç§æ¨¡å¼çš„ä¸€ä¸ªæ˜¾è‘—ç¼ºç‚¹æ˜¯å®ƒå°†å®¢æˆ·ç«¯ä¸æœåŠ¡æ³¨å†Œä¸­å¿ƒè€¦åˆåœ¨ä¸€èµ·ã€‚æ‚¨å¿…é¡»ä¸ºæœåŠ¡å®¢æˆ·ç«¯ä½¿ç”¨çš„æ¯ç§ç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶å®ç°å®¢æˆ·ç«¯æœåŠ¡å‘ç°é€»è¾‘ã€‚
2. æœåŠ¡ç«¯å‘ç°
    1. 

å›ç­”é—®é¢˜

1. IPåœ°å€æ˜¯éšæœºåˆ†é…çš„ å®¢æˆ·ç«¯æ— æ³•çŸ¥é“æœåŠ¡å™¨çš„ip å› æ­¤æ— æ³•è°ƒç”¨   åŠ å…¥æ¥äº†

å¾®æœåŠ¡ åªéœ€è¦çŸ¥é“æœåŠ¡åç§° ç›´æ¥é“¾æ¥åˆ°æœåŠ¡åç§°å°±å¯ä»¥äº† æœåŠ¡æ–°å¢ ä¸‹çº¿

æ³¨å†Œä¸­å¿ƒä¹Ÿå¯ä»¥å®æ—¶é€šçŸ¥
 2. ç§Ÿçº¦å¯ä»¥æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦æ‰çº¿äº†  watchå¯ä»¥çŸ¥é“æœåŠ¡æ–°å¢å’Œå‡å°‘ æ›´æ–°æ³¨å†Œä¸­å¿ƒ

1. resolver æœåŠ¡å°†IPè½¬åŒ–ä¸ºåç§° load balancer è´Ÿè´£å®¢æˆ·ç«¯çš„è´Ÿè½½å‡è¡¡
2. client-side discovery ç”±å®¢æˆ·ç«¯åšè½®è®­  

server-side discovery æœåŠ¡åº—å‘ç°åªéœ€è¦çŸ¥é“ä¸€ä¸ªä¸­å¿ƒåœ°å€ ç”±æœåŠ¡å™¨å»åšè½®è®­

1. ç®€å•æ˜“äºå®ç° ä¸ç”¨è¿‡å¤šå¤æ‚çš„é…ç½®

### é¢è¯•å›ç­”

**1. ä¸ºä»€ä¹ˆå¾®æœåŠ¡éœ€è¦æœåŠ¡æ³¨å†Œä¸å‘ç°ï¼Ÿä¸ºä»€ä¹ˆä¸èƒ½å†™æ­» IPï¼Ÿ**

### é¢è¯•ç‰ˆæ ‡å‡†å›ç­”

> åœ¨å¾®æœåŠ¡æ¶æ„é‡Œï¼ŒæœåŠ¡å®ä¾‹ç»å¸¸ä¼šåŠ¨æ€å˜åŒ–ï¼š
> 
> - ä¼šè‡ªåŠ¨æ‰©ç¼©å®¹ï¼Œå®ä¾‹éšæ—¶å¢åŠ /å‡å°‘
> - éƒ¨ç½²åœ¨å®¹å™¨/K8s é‡Œï¼ŒPod IP ç»å¸¸å˜åŒ–
> - æ•…éšœå®ä¾‹éœ€è¦åŠæ—¶æ‘˜é™¤
> 
> å¦‚æœåœ¨è°ƒç”¨æ–¹**å†™æ­» IP:Port**ï¼Œæ¯æ¬¡æ‰©å®¹ã€ç¼©å®¹ã€è¿ç§»éƒ½è¦æ”¹é…ç½®ã€é‡å¯ï¼Œéå¸¸ä¸å¯é ã€‚
> 
> æ‰€ä»¥æˆ‘ä»¬å¼•å…¥**æœåŠ¡æ³¨å†Œä¸­å¿ƒ**ï¼š
> 
> - æœåŠ¡å¯åŠ¨æ—¶æŠŠè‡ªå·±çš„ä¿¡æ¯æ³¨å†Œè¿›å»ï¼ˆserviceName, addr, metaâ€¦ï¼‰
> - è°ƒç”¨æ–¹åªéœ€è¦**çŸ¥é“æœåŠ¡å**ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒæ‹¿å½“å‰å¯ç”¨å®ä¾‹åˆ—è¡¨
> - å½“å®ä¾‹ä¸Šä¸‹çº¿æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒé€šè¿‡ **watch/é€šçŸ¥æœºåˆ¶** æŠŠå˜æ›´åŒæ­¥ç»™è°ƒç”¨æ–¹
> 
> è¿™æ ·å¯ä»¥åšåˆ°ï¼š
> 
> - ç»Ÿä¸€æœåŠ¡å‘ç°
> - åŠ¨æ€è´Ÿè½½å‡è¡¡
> - æ— éœ€æ‰‹å·¥ç»´æŠ¤ IP åˆ—è¡¨ï¼Œè¿ç»´æˆæœ¬å¤§å¹…ä¸‹é™ã€‚

**2. åœ¨ etcd é‡Œï¼Œç§Ÿçº¦ï¼ˆLeaseï¼‰ã€TTLã€watch å„è‡ªåšä»€ä¹ˆï¼Ÿ**

åœ¨ etcd é‡Œï¼Œç”¨ **Lease + TTL + Watch** ç»„åˆå®ç°æ³¨å†Œå‘ç°æ˜¯å¸¸è§æ–¹æ¡ˆï¼š

- **ç§Ÿçº¦ï¼ˆLeaseï¼‰+ TTL**
    - æœåŠ¡æ³¨å†Œæ—¶ï¼Œä¸æ˜¯ç›´æ¥å†™ä¸€ä¸ªæ°¸ä¹… keyï¼Œè€Œæ˜¯**ç”³è¯·ä¸€ä¸ªå¸¦ TTL çš„ç§Ÿçº¦**ï¼ˆæ¯”å¦‚ 10 ç§’ï¼‰ã€‚
    - æ³¨å†Œä¿¡æ¯ key ç»‘å®šåˆ°è¿™ä¸ªç§Ÿçº¦ä¸Šã€‚
    - æœåŠ¡ä¼šå®šæœŸåš **KeepAlive å¿ƒè·³**ï¼Œç»­çº¦è¿™ä¸ª Leaseã€‚
    - å¦‚æœæœåŠ¡æŒ‚äº†ï¼Œå¿ƒè·³åœæ­¢ï¼ŒLease è¿‡æœŸï¼Œetcd å°±ä¼šè‡ªåŠ¨åˆ é™¤è¿™ä¸ª keyï¼Œç›¸å½“äºè‡ªåŠ¨æ‘˜é™¤æ•…éšœå®ä¾‹ã€‚
- **Watch**
    - è°ƒç”¨æ–¹ä¸ä¼šä¸€ç›´è½®è¯¢ etcdï¼Œè€Œæ˜¯å¯¹æŸä¸ªå‰ç¼€åš `watch`ï¼Œä¾‹å¦‚ `/gopherex/services/wallet-service/`ã€‚
    - ä¸€æ—¦æœ‰å®ä¾‹æ³¨å†Œ/ä¸‹çº¿/ä¿¡æ¯å˜æ›´ï¼Œwatch ä¼šæ”¶åˆ°äº‹ä»¶ï¼Œè°ƒç”¨æ–¹å°±å¯ä»¥**ç«‹åˆ»æ›´æ–°æœ¬åœ°çš„å®ä¾‹åˆ—è¡¨**ã€‚

**3. åœ¨ gRPC é‡Œï¼Œresolver å’Œ load balancer å„åšä»€ä¹ˆï¼Ÿ**

åœ¨ gRPC client é‡Œï¼Œ**Name Resolver** å’Œ **Load Balancer** åˆ†å·¥æ˜¯è¿™æ ·çš„ï¼š

- **Resolver**ï¼ˆåå­—è§£æå™¨ï¼‰
    - è´Ÿè´£æŠŠä¸€ä¸ªâ€œé€»è¾‘åœ°å€â€è§£ææˆä¸€ç»„â€œç‰©ç†åœ°å€â€ã€‚
    - æ¯”å¦‚æˆ‘ä»¬ Dialï¼š`gopherex:///wallet-service`
    - resolver ä¼šå»æ³¨å†Œä¸­å¿ƒï¼ˆetcdï¼‰æ‹¿åˆ°å½“å‰æ‰€æœ‰ `wallet-service` å®ä¾‹çš„ IP:Port åˆ—è¡¨ï¼Œå¹¶åœ¨æœ‰å˜æ›´æ—¶æ›´æ–°è¿™ä¸ªåˆ—è¡¨ã€‚
- **Load Balancer**ï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰
    - æ‹¿åˆ° resolver æä¾›çš„åœ°å€åˆ—è¡¨åï¼Œè´Ÿè´£ï¼š
        - å»ºç«‹ã€ç»´æŠ¤åˆ°è¿™äº›å®ä¾‹çš„è¿æ¥æ± 
        - å†³å®šæ¯ä¸€æ¬¡è¯·æ±‚å‘åˆ°å“ªä¸€ä¸ªå®ä¾‹ï¼ˆround_robin / pick_first / è‡ªå®šä¹‰ç­–ç•¥ï¼‰

**4. client-side discovery vs server-side discovery æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

> ä¸¤ç§æ¨¡å¼çš„æ ¸å¿ƒåŒºåˆ«åœ¨äºï¼šâ€œé€‰å“ªä¸ªå®ä¾‹å»è°ƒç”¨â€è¿™ä¸ªå†³ç­–æ˜¯è°åšçš„ã€‚
> 
> 
> 1ï¼‰**Client-side discovery**ï¼ˆå®¢æˆ·ç«¯å‘ç°ï¼‰
> 
> - è°ƒç”¨æ–¹ç›´æ¥ä»æ³¨å†Œä¸­å¿ƒæ‹¿åˆ°æœåŠ¡å®ä¾‹åˆ—è¡¨ã€‚
> - è°ƒç”¨æ–¹æœ¬åœ°å®ç°è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆround_robinã€æƒé‡ã€å°±è¿‘ç­‰ï¼‰ã€‚
> - gRPC + etcd + è‡ªå®šä¹‰ resolver å°±æ˜¯å…¸å‹çš„ client-side discoveryã€‚
> 
> 2ï¼‰**Server-side discovery**ï¼ˆæœåŠ¡ç«¯å‘ç°ï¼‰
> 
> - è°ƒç”¨æ–¹åªçŸ¥é“ä¸€ä¸ªå›ºå®šå…¥å£ï¼ˆæ¯”å¦‚ Nginx/Envoy/Kongï¼‰ã€‚
> - ç”±è¿™ä¸ªå…¥å£å»æŸ¥è¯¢æ³¨å†Œä¸­å¿ƒï¼Œå¹¶åœ¨åç«¯å®ä¾‹ä¹‹é—´åšè´Ÿè½½å‡è¡¡ã€‚
> - è°ƒç”¨æ–¹åªè·Ÿç½‘å…³/LB é€šä¿¡ï¼Œä¸å…³å¿ƒåç«¯å…·ä½“å®ä¾‹ã€‚
> 
> å¯¹æ¯”ï¼š
> 
> - client-side ä¼˜ç‚¹ï¼šé€»è¾‘æ¸…æ™°ã€å¯ä»¥æ ¹æ®ä¸šåŠ¡è‡ªå®šä¹‰æ›´ä¸°å¯Œçš„è´Ÿè½½ç­–ç•¥ï¼Œå‡å°‘é¢å¤–ä¸­é—´å±‚ã€‚
> - server-side ä¼˜ç‚¹ï¼šå¯¹ client é€æ˜ï¼Œå‡çº§/æ‰©å±• LB ç­–ç•¥ä¸ç”¨æ”¹ clientã€‚

5.

- etcd æœ¬èº«æ˜¯ä¸€ä¸ª**é«˜å¯ç”¨çš„ä¸€è‡´æ€§ KV å­˜å‚¨**ï¼Œæ”¯æŒ Leaseã€TTLã€Watchï¼Œéå¸¸é€‚åˆåšæ³¨å†Œä¸­å¿ƒã€‚
- å’Œ gRPC çš„ **resolver æ¨¡å‹å¥‘åˆ**ï¼šresolver ä» etcd æ‹‰åœ°å€ï¼ŒLB åšè´Ÿè½½å‡è¡¡ï¼Œä¸éœ€è¦é¢å¤–çš„ sidecar æˆ–å¤–éƒ¨ LBã€‚
- å¯¹ Go å¼€å‘æ¥è¯´å®ç°æˆæœ¬ä½ï¼šç›´æ¥ç”¨ etcd clientv3 å°±èƒ½åšå‡ºåŠ¨æ€æ³¨å†Œã€å¥åº·æ‘˜é™¤å’Œå˜æ›´é€šçŸ¥ã€‚

### æœåŠ¡å‘ç°goä»£ç 

1. æ¥å£å®šä¹‰

```solidity
type Instance struct {
	ID       string            // ç®€å•çš„ç”¨ip:portçš„æ–¹å¼
	Name     string            // æœåŠ¡åç§° eg:"wallet-service"
	Addr     string            // ip:port
	MetaData map[string]string // ä¸€äº›å…¶ä»–ä¿¡æ¯
}

// æ¥å£éœ€è¦çš„å‚æ•°
type Register interface {
	Register(ctx context.Context, ins *Instance) error
	UnRegister(ctx context.Context, ins *Instance) error
}
```

1. æœåŠ¡çš„å®ç°

```solidity
func (e *EtcdRegister) Register(ctx context.Context, ins *register.Instance) error {
	// è¿›è¡Œç§Ÿçº¦
	grandRes, err := e.client.Grant(ctx, e.ttl)
	if err != nil {
		return err
	}
	// è·å–ç§Ÿçº¦çš„id
	e.leaseID = grandRes.ID
	// å°†å†…å®¹å†™å…¥kv
	val, err := json.Marshal(ins)
	if err != nil {
		return err
	}
	key := e.getKey(ins)
	_, err = e.client.Put(ctx, key, string(val), clientv3.WithLease(e.leaseID))
	if err != nil {
		return err
	}
	// ç”Ÿæˆä¸€ä¸ªå¿ƒè·³
	keepliveChat, err := e.client.KeepAlive(ctx, e.leaseID)
	if err != nil {
		return err
	}
	e.keepaliveChan = keepliveChat
	go e.keepliveChan(ctx)
	return nil
}

func (e *EtcdRegister) UnRegister(ctx context.Context, ins *register.Instance) error {
	// æå‡ºkey  æ¥è§¦ç»­çº¦
	_, err := e.client.Delete(ctx, e.getKey(ins))
	if err != nil {
		return fmt.Errorf("delete instance: %w", err)
	}
	_, err = e.client.Revoke(ctx, e.leaseID)
	if err != nil {
		return fmt.Errorf("Revoke instance: %w", err)
	}
	return nil
}

func (e *EtcdRegister) keepliveChan(ctx context.Context) {
	for {
		select {
		case <-ctx.Done():
			// ä¸ºä»€ä¹ˆä¸åœ¨è¿™é‡Œæ³¨é”€å‘¢ï¼Ÿ
			return
		case <-e.keepaliveChan:
			//è‡ªåŠ¨ç»­çº¦ æ— éœ€æ‰‹åŠ¨
			//logger.Info(ctx, "etcd lease keepalive success", zap.Int64("leaseID", int64(e.leaseID)))
		}
	}
}
```

<aside>
ğŸ’¡

ä¸»è¦æ˜¯å¿ƒè·³æœåŠ¡ ä¸€ç›´è¦ç»­çº¦ å¦‚æœæ²¡æœ‰ç»­çº¦çš„è¯ å°±è‡ªåŠ¨æ‰äº†

</aside>

1. æœåŠ¡çš„å®ç°

ä¸»è¦åˆ©ç”¨grpcè‡ªå¸¦çš„åŸŸåè§£æ

```solidity
func (b *memBuilder) Scheme() string {
	return "demo"
}

func (b *memBuilder) Build(target resolver.Target, cc resolver.ClientConn, _ resolver.BuildOptions) (resolver.Resolver, error) {
	// Dial é‡Œç”¨çš„æ˜¯ demo:///greeter
	// gRPC ä¼šæŠŠ "greeter" æ”¾åœ¨ target.URL.Path é‡Œï¼ˆå¸¦å‰å¯¼ '/'ï¼‰
	service := target.URL.Path
	if len(service) > 0 && service[0] == '/' {
		service = service[1:]
	}
	if service == "" {
		return nil, fmt.Errorf("empty service name in target: %v", target)
	}

	res := &memResolver{
		service: service,
		cc:      cc,
		reg:     b.reg,
	}
	// è®¢é˜… & æ¨ä¸€æ¬¡å½“å‰åœ°å€
	b.reg.subscribe(service, res)
	res.ResolveNow(resolver.ResolveNowOptions{})

	return res, nil
}

func (r *memResolver) ResolveNow(_ resolver.ResolveNowOptions) {
	addrs := r.reg.get(r.service)
	r.push(addrs)
}

func (r *memResolver) Close() {
	r.mu.Lock()
	r.closed = true
	r.mu.Unlock()
	r.reg.unsubscribe(r.service, r)
}

  // æ³¨å†Œ resolverï¼ˆå…¨å±€ï¼‰//å¯åŠ¨æœåŠ¡çš„æ—¶å€™
	resolver.Register(&memBuilder{reg: reg})

	// å…³é”®ç‚¹ï¼šè¦è®© gRPC åœ¨å¤šä¸ªåœ°å€é—´è´Ÿè½½å‡è¡¡ï¼Œä½ éœ€è¦ round_robinï¼ˆæˆ–è‡ªå®šä¹‰ LBï¼‰
	// è¿™é‡Œç”¨ service config çš„æœ€ç®€å•å†™æ³•ï¼š
	serviceCfg := `{"loadBalancingConfig":[{"round_robin":{}}]}`

// æ³¨å…¥åŸŸå è‡ªåŠ¨è§£æ   ä¹Ÿè‡ªåŠ¨èµ°å“ªç§è½®è®­
conn, err := grpc.DialContext(
		ctx,
		"demo:///greeter",
		grpc.WithTransportCredentials(insecure.NewCredentials()),
		grpc.WithDefaultServiceConfig(serviceCfg),
		grpc.WithBlock(),
	)

```

```solidity
å…¶ä¸»è¦åœ¨äºå®ç°  è¿™ä¸¤ä¸ªæ¥å£
1. buildçš„æ—¶å€™å»è°ƒå» ResolveNow
type Builder interface {
	Build(target Target, cc ClientConn, opts BuildOptions) (Resolver, error)
	Scheme() string
}

type Resolver interface {
	
	ResolveNow(ResolveNowOptions)
	// Close closes the resolver.
	Close()
}
```